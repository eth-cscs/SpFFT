#######################
#       Linux
#######################
jobs:
- template: CI/azure_templates/ubuntu_build_test.yml

#######################
#       macOS
#######################
- job: macOS_Clang
  pool:
    vmImage: 'macOS-10.14'

  steps:
  - script: |
      /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    displayName: 'Install Homebrew'

  - script: |
      brew install fftw
      brew install open-mpi
    displayName: 'Install dependencies'

  # Apple Clang does not support OpenMP
  - script: |
      mkdir -p build
      cd build
      cmake .. -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DSPFFT_BUILD_TESTS=ON -DSPFFT_MPI=ON -DSPFFT_OMP=OFF
      make VERBOSE=1
    displayName: 'Build'

  - script: |
      ./build/tests/run_local_tests
    displayName: 'Run local tests'

  - script: |
      mpirun -n 2 ./build/tests/run_mpi_tests
    displayName: 'Run MPI tests'
